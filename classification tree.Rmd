---
title: "Visualization"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, message=FALSE, warning=FALSE,
                      fig.width=7, fig.height=3, fig.align = "center")
options(digits=3)
library(tidyverse)
library(tidymodels)
library(readr)
PPH <- read_csv("PPH_newcols.csv")
```

### Create another column for severe morbidity
```{r}
#the cdc 21 severity
PPH[126:146]

PPH_ml <- PPH %>% mutate(m = as.factor( ifelse(!!rowSums(PPH[126:146]), 1, 0))) %>% select(age, race, zipinc_qrtl, obesity, diabetes, gh , mg , pp , pa , pl, hu , m)

PPH_ml %>% filter(m == 1)

```

```{r}
two_severe <- PPH %>% group_by(severe_morbidity, aprdrg_severity) %>% summarize(total = n()) 

PPH %>% ggplot(aes(x = aprdrg_severity)) + geom_bar() + facet_wrap(~ severe_morbidity)

```

CDC's Severe Maternal Morbidity and aprdrg_severity

### Figure 1. The risk for severe maternal morbidity (SMM) based on race, including transfusion (left) and roldugin transfusion (right) 

```{r}
sever <- PPH %>% filter(sever_morbidity == 1) 
a <- sever %>% group_by(race) %>% summarise(s = n())
b <- PPH %>% group_by(race) %>% summarise(total = n())
c <- cbind(a, b$total) %>% mutate(percentage = s/b$total)
```

### Figure 2. The risk for disseminated intravascular coagulation (A), transfusion (B), and hysterectomy (C) within a race for patients with postpartum hemorrhage.


### Figure 3. The risk for morbidity based on the median income of patientsâ€™ zipcode.

### CART

```{r}
#partition the dataset into train data and test data
set.seed(100)
PPH_split <- initial_split(PPH_ml, prop = 0.75, strata = m)
PPH_train <- training(PPH_split)
PPH_test <- testing(PPH_split)
```

Model 1: CART 

```{r}
# recipe
PPH_recipe <-
recipe(m ~ age + race , data = PPH_train) %>%
step_mutate(race = as.factor(race))

summary(PPH_recipe)

```

```{r}
PPH_cart <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode("classification")


PPH_cart_wflow <- workflow() %>%
  add_model(PPH_cart) %>%
  add_recipe(PPH_recipe)

PPH_cart_fit <- PPH_cart_wflow %>%
  fit(data = PPH_train)

PPH_cart_fit %>%
  predict(new_data = PPH_train) %>%
  cbind(PPH_train) %>%
  select(.pred_class, m) %>%
  table()


library(rpart.plot)
PPH_cart_plot <- 
  PPH_cart_fit %>%
  extract_fit_parsnip()

rpart.plot(
  PPH_cart_plot$fit,
  roundint = FALSE)
```


Model 2: Random Forest. Tuning parameters: mtry and number of trees.

```{r}
# recipe
PPH_rf_recipe <-
recipe(m ~. , data = PPH_train) 

summary(PPH_rf_recipe)

# variable selection

#model
PPH_rf <- rand_forest(mtry = tune(),
                           trees = tune()) %>%
  set_engine("randomForest", importance = "permutation") %>%
  set_mode("classification")


# workflow
PPH_rf_wflow <- workflow() %>%
add_model(PPH_rf) %>%
add_recipe(PPH_rf_recipe)

#create folds
set.seed(234)
PPH_folds <- vfold_cv(PPH_train, v = 5)

#grid for tuning mtry and trees
rf_grid <- grid_regular(mtry(range = c(2,11)),
                             trees(range = c(1,500)),
                             levels = 5)
#tune
PPH_rf_tune <- 
  PPH_rf_wflow %>%
  tune_grid(resamples = PPH_folds,
            grid = rf_grid)

PPH_rf_tune %>% collect_metrics() %>%
filter(.metric == "accuracy")

PPH_rf_best <- finalize_model(
  PPH_rf,
  select_best(PPH_rf_tune, "accuracy"))

PPH_rf_best
```

